<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Analyse log TL - Damage by Skill</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-family: Arial, sans-serif;
      background-color: #05070a;
      color: #fff;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; }
    input[type="file"] { margin-top: 15px; }
    #status {
      margin-top: 10px;
      min-height: 20px;
      font-weight: bold;
    }

    /* Cartes de résumé */
    .summary {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      width: 95%;
      max-width: 1600px;
    }
    .card {
      flex: 1;
      background: #11121a;
      border-radius: 8px;
      padding: 8px 12px;
      box-shadow: 0 0 14px rgba(0,0,0,0.55);
      border: 1px solid #23233a;
    }
    .card-title {
      font-size: 11px;
      text-transform: uppercase;
      color: #9b9bc0;
    }
    .card-value {
      margin-top: 4px;
      font-size: 18px;
      font-weight: 700;
      color: #ff4d6a;
    }

    /* Tableau joueurs */
    table {
      margin-top: 25px;
      border-collapse: collapse;
      width: 95%;
      max-width: 1600px;
      background-color: #151518;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 8px 12px;
      text-align: center;
      font-size: 14px;
    }
    th { background-color: #202024; }
    tr:nth-child(even) { background-color: #1a1a1f; }
    tbody tr:hover {
      background-color: #262533;
      cursor: pointer;
    }
    tr.player-selected { background-color: #3a2525; }
    td:nth-child(2) { text-align: left; }

    /* Panneaux pour les graphes */
    .panel {
      width: 95%;
      max-width: 1600px;
      margin-top: 20px;
      background: #101018;
      border-radius: 10px;
      padding: 10px 14px 14px;
      box-shadow: 0 0 18px rgba(0,0,0,0.6);
      border: 1px solid #222235;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .panel-title {
      font-size: 13px;
      font-weight: 600;
      color: #e5e5ff;
    }
    .panel-meta {
      font-size: 11px;
      color: #9a9ac2;
    }
    .panel-body {
      height: 420px;
    }

    #chartContainer, #timelineContainer {
      width: 100%;
      height: 100%;
    }

    /* Canvases : prennent toute la hauteur du parent */
    #dpsTimeline,
    #damageChart {
      width: 100% !important;
      height: 100% !important;
      max-height: none !important;
    }
  </style>
</head>
<body>
  <h1>Damage By Skill - Throne and Liberty</h1>
  <p>Choisis un ou plusieurs fichiers combatlog (.txt) exportés du jeu.</p>
  <input type="file" id="logFile" accept=".txt" multiple>
  <div id="status"></div>

  <!-- Cartes de résumé -->
  <div class="summary">
    <div class="card">
      <div class="card-title">Total Damage</div>
      <div class="card-value" id="sumTotalDamage">0</div>
    </div>
    <div class="card">
      <div class="card-title">Average DPS</div>
      <div class="card-value" id="sumAvgDps">0</div>
    </div>
    <div class="card">
      <div class="card-title">Players</div>
      <div class="card-value" id="sumPlayers">0</div>
    </div>
  </div>

  <h2>Player Statistics</h2>
  <p>Clique sur un ou plusieurs joueurs pour les comparer sur les graphiques.</p>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Player Name</th>
        <th>DPS</th>
        <th>Total Damage</th>
        <th>% Fight</th>
        <th>Hit Count</th>
        <th>Avg Hit</th>
        <th>Max Hit</th>
        <th>Duration</th>
      </tr>
    </thead>
    <tbody id="playerBody"></tbody>
  </table>

  <!-- Panel DPS Timeline -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">DPS Timeline</span>
      <span class="panel-meta" id="fightDurationMeta"></span>
    </div>
    <div class="panel-body" id="timelineContainer">
      <canvas id="dpsTimeline"></canvas>
    </div>
  </div>

  <!-- Panel Damage By Skill -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Damage By Skill</span>
      <span class="panel-meta" id="playersMeta"></span>
    </div>
    <div class="panel-body" id="chartContainer">
      <canvas id="damageChart"></canvas>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('logFile');
    const statusEl = document.getElementById('status');
    const playerBody = document.getElementById('playerBody');
    let chart;
    let dpsTimelineChart;
    let playersData = [];
    let selectedPlayers = [];

    fileInput.addEventListener('change', () => {
      const files = Array.from(fileInput.files);
      if (!files.length) return;
      statusEl.textContent = 'Lecture des fichiers...';
      playersData = [];
      selectedPlayers = [];
      playerBody.innerHTML = '';
      if (chart) chart.destroy();
      if (dpsTimelineChart) dpsTimelineChart.destroy();

      Promise.all(files.map((f, index) => parseLogFile(f, index)))
        .then(results => {
          playersData = results.filter(r => r !== null);
          if (!playersData.length) {
            statusEl.textContent = 'Aucune donnée valide trouvée dans les logs.';
            return;
          }
          playersData.sort((a, b) => b.dps - a.dps);

          const totalFightDamage = playersData.reduce((s, p) => s + p.totalDamage, 0);
          const avgDps = playersData.reduce((s, p) => s + p.dps, 0) / playersData.length;
          document.getElementById('sumTotalDamage').textContent =
            totalFightDamage.toLocaleString('fr-FR');
          document.getElementById('sumAvgDps').textContent =
            Math.round(avgDps).toLocaleString('fr-FR');
          document.getElementById('sumPlayers').textContent = playersData.length;

          renderPlayerTable(playersData);
          statusEl.textContent = `Logs analysés : ${playersData.length}`;

          selectedPlayers = [playersData[0]];
          highlightSelectedRows();
          drawComparisonChart();
          drawDpsTimeline();
        })
        .catch(err => {
          statusEl.textContent = 'Erreur : ' + err;
        });
    });

    function parseLogFile(file, index) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const text = reader.result;
            const lines = text.split(/\r?\n/);

            const damageBySkill = {};
            const damageTimeline = {};
            let totalDamage = 0;
            let hitCount = 0;
            let maxHit = 0;
            let firstTs = null;
            let lastTs = null;
            let playerName = 'Unknown';
            let bossName = 'Unknown';

            for (const line of lines) {
              if (!line) continue;
              const parts = line.split(',');
              if (parts.length < 10) continue;

              const type = (parts[1] || '').trim().toLowerCase();
              if (!type.includes('damage')) continue;

              const ts = parts[0].trim();
              const skillName = parts[2].trim();
              const dmgStr = parts[4].trim().replace(/\s/g, '');
              const dmg = parseInt(dmgStr, 10);
              const player = parts[parts.length - 2].trim();
              const boss = parts[parts.length - 1].trim();

              if (!isNaN(dmg) && dmg > 0) {
                totalDamage += dmg;
                hitCount += 1;
                if (dmg > maxHit) maxHit = dmg;

                if (!damageBySkill[skillName]) damageBySkill[skillName] = 0;
                damageBySkill[skillName] += dmg;

                if (!firstTs) firstTs = ts;
                const secFromStart = computeSecondsDiff(firstTs, ts);
                if (!damageTimeline[secFromStart]) damageTimeline[secFromStart] = 0;
                damageTimeline[secFromStart] += dmg;
              }

              if (!firstTs) firstTs = ts;
              lastTs = ts;
              playerName = player;
              bossName = boss;
            }

            if (hitCount === 0 || !firstTs || !lastTs) {
              resolve(null);
              return;
            }

            const duration = computeDurationSeconds(firstTs, lastTs);
            const dps = duration > 0 ? Math.round(totalDamage / duration) : totalDamage;
            const avgHit = Math.round(totalDamage / hitCount);

            resolve({
              index,
              playerName,
              bossName,
              totalDamage,
              hitCount,
              maxHit,
              avgHit,
              duration,
              dps,
              damageBySkill,
              damageTimeline
            });
          } catch {
            resolve(null);
          }
        };
        reader.onerror = () => resolve(null);
        reader.readAsText(file);
      });
    }

    function computeDurationSeconds(ts1, ts2) {
      const parse = (ts) => {
        const [datePart, timePart] = ts.split('-');
        const year = parseInt(datePart.slice(0,4), 10);
        const month = parseInt(datePart.slice(4,6), 10) - 1;
        const day = parseInt(datePart.slice(6,8), 10);
        const [h, m, s, ms] = timePart.split(':').map(x => parseInt(x, 10));
        return new Date(year, month, day, h, m, s, ms);
      };
      try {
        const d1 = parse(ts1);
        const d2 = parse(ts2);
        return Math.max(1, Math.round((d2 - d1) / 1000));
      } catch {
        return 1;
      }
    }

    function computeSecondsDiff(tsStart, tsCurrent) {
      const parse = (ts) => {
        const [datePart, timePart] = ts.split('-');
        const year = parseInt(datePart.slice(0,4), 10);
        const month = parseInt(datePart.slice(4,6), 10) - 1;
        const day = parseInt(datePart.slice(6,8), 10);
        const [h, m, s, ms] = timePart.split(':').map(x => parseInt(x, 10));
        return new Date(year, month, day, h, m, s, ms);
      };
      try {
        const d1 = parse(tsStart);
        const d2 = parse(tsCurrent);
        return Math.max(0, Math.floor((d2 - d1) / 1000));
      } catch {
        return 0;
      }
    }

    function renderPlayerTable(players) {
      playerBody.innerHTML = '';
      const totalFightDamage = players.reduce((sum, p) => sum + p.totalDamage, 0);

      players.forEach((p, idx) => {
        const tr = document.createElement('tr');
        tr.dataset.index = p.index;
        const percent =
          totalFightDamage > 0 ? (p.totalDamage / totalFightDamage) * 100 : 0;

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${p.playerName}</td>
          <td>${p.dps.toLocaleString('fr-FR')}</td>
          <td>${p.totalDamage.toLocaleString('fr-FR')}</td>
          <td>${percent.toFixed(2)}%</td>
          <td>${p.hitCount.toLocaleString('fr-FR')}</td>
          <td>${p.avgHit.toLocaleString('fr-FR')}</td>
          <td>${p.maxHit.toLocaleString('fr-FR')}</td>
          <td>${p.duration}s</td>
        `;
        if (idx === 0) tr.style.borderLeft = '3px solid #ff4d6a';
        tr.addEventListener('click', () => onPlayerRowClick(p));
        playerBody.appendChild(tr);
      });
    }

    function onPlayerRowClick(player) {
      const exists = selectedPlayers.find(p => p.index === player.index);
      if (exists) {
        selectedPlayers = selectedPlayers.filter(p => p.index !== player.index);
      } else {
        selectedPlayers.push(player);
      }
      highlightSelectedRows();
      drawComparisonChart();
      drawDpsTimeline();
    }

    function highlightSelectedRows() {
      const rows = playerBody.querySelectorAll('tr');
      rows.forEach(row => {
        const idx = parseInt(row.dataset.index, 10);
        const isSelected = selectedPlayers.some(p => p.index === idx);
        row.classList.toggle('player-selected', isSelected);
      });
    }

    function drawComparisonChart() {
      const ctx = document.getElementById('damageChart').getContext('2d');
      if (chart) chart.destroy();
      const playersMeta = document.getElementById('playersMeta');

      if (!selectedPlayers.length) {
        playersMeta.textContent = '';
        return;
      }

      const skillTotals = {};
      selectedPlayers.forEach(p => {
        Object.entries(p.damageBySkill).forEach(([skill, dmg]) => {
          if (!skillTotals[skill]) skillTotals[skill] = 0;
          skillTotals[skill] += dmg;
        });
      });

      const labels = Object.entries(skillTotals)
        .sort((a, b) => b[1] - a[1])
        .map(e => e[0]);

      const colors = [
        'rgba(88, 101, 242, 0.8)',
        'rgba(46, 204, 113, 0.8)',
        'rgba(231, 76, 60, 0.8)',
        'rgba(241, 196, 15, 0.8)',
        'rgba(155, 89, 182, 0.8)',
        'rgba(26, 188, 156, 0.8)',
        'rgba(230, 126, 34, 0.8)',
        'rgba(149, 165, 166, 0.8)'
      ];
      const borderColors = [
        'rgba(88, 101, 242, 1)',
        'rgba(46, 204, 113, 1)',
        'rgba(231, 76, 60, 1)',
        'rgba(241, 196, 15, 1)',
        'rgba(155, 89, 182, 1)',
        'rgba(26, 188, 156, 1)',
        'rgba(230, 126, 34, 1)',
        'rgba(149, 165, 166, 1)'
      ];

      const datasets = selectedPlayers.map((p, idx) => {
        const data = labels.map(skill => p.damageBySkill[skill] || 0);
        return {
          label: p.playerName,
          data,
          backgroundColor: colors[idx % colors.length],
          borderColor: borderColors[idx % borderColors.length],
          borderWidth: 1
        };
      });

      playersMeta.textContent = selectedPlayers.length === 1
        ? selectedPlayers[0].playerName
        : selectedPlayers.map(p => p.playerName).join(' vs ');

      /* --- hauteur dynamique du panel en fonction du nombre de skills --- */
      const baseHeight = 260;      // hauteur pour ~10 skills
      const perSkill = 20;         // +20px par skill au-dessus de 10
      const extra = Math.max(0, labels.length - 10);
      const newHeight = baseHeight + extra * perSkill;
      const panelBody = document.getElementById('chartContainer');
      panelBody.style.height = newHeight + 'px';
      /* ------------------------------------------------------------------ */

      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,   /* respecte la hauteur CSS[web:327] */
          plugins: {
            legend: { display: true },
            title: { display: false }
          },
          scales: {
            x: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });
    }

    function drawDpsTimeline() {
      const ctx = document.getElementById('dpsTimeline').getContext('2d');
      if (dpsTimelineChart) dpsTimelineChart.destroy();
      const fightMeta = document.getElementById('fightDurationMeta');
      if (!selectedPlayers.length) {
        fightMeta.textContent = '';
        return;
      }

      const maxDuration = Math.max(...selectedPlayers.map(p => p.duration));
      fightMeta.textContent = `${maxDuration}s`;

      const labels = [];
      for (let s = 0; s <= maxDuration; s++) labels.push(`${s}s`);

      const colors = [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255, 159, 64, 1)',
        'rgba(46, 204, 113, 1)',
        'rgba(231, 76, 60, 1)',
        'rgba(52, 152, 219, 1)',
        'rgba(241, 196, 15, 1)'
      ];

      const datasets = selectedPlayers.map((p, idx) => {
        const data = [];
        for (let s = 0; s <= maxDuration; s++) {
          const dmg = p.damageTimeline[s] || 0;
          data.push(dmg);
        }
        return {
          label: p.playerName,
          data,
          borderColor: colors[idx % colors.length],
          backgroundColor: 'transparent',
          pointRadius: 0,
          borderWidth: 1.5,
          tension: 0.2
        };
      });

      dpsTimelineChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            title: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y || 0;
                  return `${ctx.dataset.label}: ${v.toLocaleString('fr-FR')} DPS`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.08)' }
            },
            y: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.08)' }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
