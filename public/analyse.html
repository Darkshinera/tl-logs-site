<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Analyse log TL - Damage by Skill</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-family: Arial, sans-serif;
      background-color: #05070a;
      color: #fff;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; }
    #chartContainer {
      width: 90%;
      max-width: 1200px;
      height: 600px;
      margin-top: 30px;
    }
    input[type="file"] {
      margin-top: 15px;
    }
    #status {
      margin-top: 10px;
      min-height: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Damage By Skill - Throne and Liberty</h1>
  <p>Choisis un fichier combatlog (.txt) exporté du jeu.</p>
  <input type="file" id="logFile" accept=".txt">
  <div id="status"></div>

  <div id="chartContainer">
    <canvas id="damageChart"></canvas>
  </div>

  <script>
    const fileInput = document.getElementById('logFile');
    const statusEl = document.getElementById('status');
    let chart;

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;
      statusEl.textContent = 'Lecture du fichier...';

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = reader.result;
          const lines = text.split(/\\r?\\n/);

          // Agrégation des dégâts par sort
          const damageBySkill = {};

          for (const line of lines) {
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 5) continue;

            const type = parts[1];
            if (type !== 'DamageDone') continue;

            const skillName = parts[2].trim();
            const damageStr = parts[4].trim();
            const damage = parseInt(damageStr, 10);
            if (isNaN(damage) || damage <= 0) continue;

            if (!damageBySkill[skillName]) {
              damageBySkill[skillName] = 0;
            }
            damageBySkill[skillName] += damage;
          }

          const entries = Object.entries(damageBySkill);
          if (entries.length === 0) {
            statusEl.textContent = 'Aucune donnée DamageDone trouvée.';
            return;
          }

          // Trier par dégâts décroissants
          entries.sort((a, b) => b[1] - a[1]);

          const labels = entries.map(e => e[0]);
          const data = entries.map(e => e[1]);

          statusEl.textContent = `Compétences trouvées : ${labels.length}`;

          drawChart(labels, data);
        } catch (e) {
          statusEl.textContent = 'Erreur de parsing : ' + e.message;
        }
      };
      reader.onerror = () => {
        statusEl.textContent = 'Erreur de lecture du fichier.';
      };
      reader.readAsText(file);
    });

    function drawChart(labels, data) {
      const ctx = document.getElementById('damageChart').getContext('2d');

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Damage total',
            data: data,
            backgroundColor: 'rgba(88, 101, 242, 0.8)'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: 'Damage By Skill'
            }
          },
          scales: {
            x: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });
    }
  </script>
</body>
</html>

